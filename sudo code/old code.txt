<!-- wp:html -->
<style>
  input[type="file"] {
    display: block;
    margin: 20px auto;
    font-size: 15px;
  }

  .btn1 {
    background-color: #3498db;
    color: white;
    padding: 12px 28px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: block;
    margin: 0 auto 25px auto;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
  }

  .btn1:hover {
    background-color: #2980b9;
    transform: translateY(-1px);
  }

  .label {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 17px;
    margin-top: 25px;
  }

  .box {
    background: #ecf0f1;
    padding: 10px;
    border-left: 5px solid #3498db;
    border-radius: 8px;
    white-space: normal;
    font-size: 15px;
    margin-bottom: 20px;
    max-height: 400px;
    overflow: hidden;
    overflow-y: auto;
  }
  .table-wrapper {
    overflow-x: auto;
    border-radius: 6px;
    margin-top: 12px;
    border: 1px solid #ccc;
  }

  .scroll-table {
    max-height: 360px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  th, td {
    border: 1px solid #bdc3c7;
    padding: 8px 12px;
    text-align: center;
  }

  th {
    background-color: #1B2641;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  tr:hover {
    background-color: #e1ecf4;
  }
.btns {
    width: 50%;
  display: flex;
  align-items: center;
  margin-left: -35px;
}
.btn1,#llmBtn{
    margin-top:25px;
    background-color: #01ffff;
    color: #0A0E18 ;
    font-size: 20px;
    padding: 10px 30px;
    border: 1px solid #01ffff;
}
.btn1:hover,#llmBtn:hover{
    background-color:#1B2641 ;
    color:  #01ffff;
    border: 1px solid #01ffff;
}
button#llmBtn {
    margin-top: 20px;
    margin-bottom: 20px;
}


.btn:focus,
.btn:active {
    background-color: #01ffff;
    color: #0A0E18;
}


.label{
    color:white;
}

input[type="file"] {
  padding: 10px 16px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
  color: #333;
  font-size: 14px;
  cursor: pointer;
  transition: border-color 0.3s, box-shadow 0.3s;
}

input[type="file"]:hover {
  border-color: #3498db;
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.4);
}

input[type="file"]::-webkit-file-upload-button {
  background-color:#1B2641 ;
  color: white;
  padding: 8px 14px;
  border: 1px solid #1B2641;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.3s;
}

input[type="file"]::-webkit-file-upload-button:hover {
  background-color: white;
  color:#1B2641;
}
#summaryBox, #llmSuggestionBox,#predictionBox{
    font-size: 18px;
}

</style>

<div class="container1">

    <div class="btns">
      <input id="csvFile" accept=".csv" type="file" />
      <button class="btn1" onclick="sendData()">Predict</button>
    </div>

    <div class="label">üìä Prediction Summary:</div>
    <div id="summaryBox" class="box">Waiting for input...</div>

    <div class="label">üìã Detailed Prediction Table:</div>
    <div id="predictionBox" class="box">No data yet.</div>

    <div class="label">üß† LLM Suggestion:</div>
    <button id="llmBtn" class="btn" style="display: none;" onclick="getLLMSuggestion()">üí° Get LLM Suggestion</button>
    <div id="llmSuggestionBox" class="box">No suggestion fetched yet.</div>
</div>
</div>

<!-- Optional Chat UI -->
<div id="chatbox" style="display: none; max-width: 600px; margin: 20px auto;">
    <div class="box" id="chatLog">üîí Start your cybersecurity chat below:</div>
    <input type="text" id="chatInput" placeholder="Ask your question..."
        style="width: 100%; padding: 10px; margin-top: 10px;" />
    <button class="btn" onclick="sendMessage()">Send</button>
</div>

<script>
    let lastData = null;

    function sendData() {
        const fileInput = document.getElementById('csvFile');
        const reader = new FileReader();

        reader.onload = function (event) {
            const csv = event.target.result;
            const rows = csv.split('\n');
            const headers = rows[0].split(',');

            const jsonData = rows.slice(1).filter(Boolean).map(row => {
                const values = row.split(',');
                const obj = {};
                headers.forEach((h, i) => (obj[h.trim()] = values[i]?.trim() || ""));
                return obj;
            });

            lastData = jsonData;

            fetch('http://127.0.0.1:8000/api/predict-only/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: jsonData }),
            })
                .then(res => res.json())
                .then(data => {
                    const summaryText = `
Total Samples: ${data.total}
Attack Count: ${data.attack_count}
Benign Count: ${data.benign_count}
Attack Percentage: ${data.attack_percentage}%`.trim();

                    document.getElementById('summaryBox').textContent = summaryText;

                    const predictions = data.result_data;
                    if (predictions && predictions.length > 0) {
                        let table = `<table><thead><tr>
              <th>#</th>
              <th>Prediction</th>
              <th>Attack Confidence</th>
              <th>Entropy</th>
              <th>Margin</th>
            </tr></thead><tbody>`;

                        predictions.forEach((item, i) => {
                            table += `<tr>
                <td>${i + 1}</td>
                <td>${item.prediction}</td>
                <td>${(item.attack_confidence * 100).toFixed(2)}%</td>
                <td>${item.entropy}</td>
                <td>${item.margin}%</td>
              </tr>`;
                        });

                        table += "</tbody></table>";
                        document.getElementById('predictionBox').innerHTML = table;
                    } else {
                        document.getElementById('predictionBox').textContent = "No prediction data available.";
                    }

                    document.getElementById('llmSuggestionBox').textContent = "No suggestion fetched yet.";
                    document.getElementById('llmBtn').style.display = "block";
                })
                .catch(err => alert("‚ùå Error: " + err));
        };

        if (fileInput.files.length > 0) {
            reader.readAsText(fileInput.files[0]);
        } else {
            alert("Please select a CSV file");
        }
    }

    function typeText(element, text, delay = 30) {
        element.textContent = "";
        let i = 0;
        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(type, delay);
            }
        }
        type();
    }

    function getLLMSuggestion() {
        if (!lastData) {
            alert("‚ùå Please upload and predict data first.");
            return;
        }

        const btn = document.getElementById('llmBtn');
        const suggestionBox = document.getElementById('llmSuggestionBox');
        btn.disabled = true;
        btn.textContent = "Thinking";

        let dotCount = 0;
        const loadingInterval = setInterval(() => {
            dotCount = (dotCount + 1) % 4;
            btn.textContent = "Thinking" + ".".repeat(dotCount);
        }, 400);

        const summaryBox = document.getElementById('summaryBox').textContent;
        const attackCount = parseInt(summaryBox.match(/Attack Count: (\d+)/)?.[1] || 0);
        const benignCount = parseInt(summaryBox.match(/Benign Count: (\d+)/)?.[1] || 0);
        const attackPercentage = parseFloat(summaryBox.match(/Attack Percentage: ([\d.]+)/)?.[1] || 0);
        const total = parseInt(summaryBox.match(/Total Samples: (\d+)/)?.[1] || 0);

        fetch('http://127.0.0.1:8000/api/azure-llm-suggest/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                attack_percentage: attackPercentage,
                attack_count: attackCount,
                benign_count: benignCount,
                total: total,
            }),
        })
            .then((res) => res.json())
            .then((data) => {
                clearInterval(loadingInterval);
                btn.disabled = false;
                btn.textContent = "Get LLM Suggestion";
                const suggestion = data.llm_suggestion || "No suggestion returned.";
                typeText(suggestionBox, suggestion, 30);
            })
            .catch((err) => {
                clearInterval(loadingInterval);
                btn.disabled = false;
                btn.textContent = "Get LLM Suggestion";
                alert("‚ùå Error: " + err);
            });
    }

</script>

<!-- /wp:html -->